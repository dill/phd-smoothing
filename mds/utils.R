# utility functions


# routine to Pick Elements, pe
pe<-function(this.list,el){
   lapply(this.list,function(x) x[el])
}

# find the intersection point between two points and a line
intersection_point<-function(p1,p2,edge){
   # args:
   #  p1, p2      the two points making up the end points of the line
   #  line         boundary of the shape to test intersection with
   # return:
   #     intersection point

   eps<-1e-16

   # calculation of intersection is straight from 
   # Handbook of Mathematics Bronstein et al. pp. 195,196


   # handle the horizontal/vertical line case...
#   if(abs(p2$x-p1$x) <eps) p1$x<-0
#   if(abs(p2$y-p1$y)<eps) p1$y<-0
#   if(abs(edge$x[2]-edge$x[1])<eps) edge$x[1]<-0
#   if(abs(edge$y[2]-edge$y[1])<eps) edge$y[1]<-0

   if(p2$x==p1$x) p1$x<-0
   if(p2$y==p1$y) p1$y<-0
   if(edge$x[2]==edge$x[1]) edge$x[1]<-0
   if(edge$y[2]==edge$y[1]) edge$y[1]<-0

   ### calculate intersection point
   # first calculate the coefficients for the lines
   # the line between the points
   a1<- -1/(p2$x-p1$x)
   b1<- 1/(p2$y-p1$y)
   c1<- p1$x/(p2$x-p1$x)-p1$y/(p2$y-p1$y)

   # the edge
   a2<- -1/(edge$x[2]-edge$x[1])
   b2<- 1/(edge$y[2]-edge$y[1])
   c2<- edge$x[1]/(edge$x[2]-edge$x[1])-edge$y[1]/(edge$y[2]-edge$y[1])

   ### do something to check for infinities...
   if(all(c(a1,a2,b1,b2,c1,c2)!=Inf) & all(c(a1,a2,b1,b2,c1,c2)!=-Inf)){
      # calculate the intersection
      intx<-det(matrix(c(b1,b2,c1,c2),2,2))/det(matrix(c(a1,a2,b1,b2),2,2))
      inty<-det(matrix(c(c1,c2,a1,a2),2,2))/det(matrix(c(a1,a2,b1,b2),2,2))
      ret<-list(x=intx,y=inty)
   }else{
      ret<-list(x=Inf,y=Inf)
   }

   return(ret)

}


# calculate the length of the convex hull
hull_length<-function(hull){
   # args:
   #  hull        convex hull (list(x=,y=))
   # return
   #     its length

   hullen<-0

   for (i in 1:(length(hull$x)-1)){
      hullen<-hullen+sqrt((hull$x[i+1]-hull$x[i])^2+(hull$y[i+1]-hull$y[i])^2)
   }

   return(hullen)

}



# do two points and the boundary intersect?
do_intersect<-function(p1,p2,bnd){
   # we do this by seeing if the bounding boxes intersect
   # from Mastering Algorithms with Perl, p 451

   eps<-1e-16

   # returns a string of T/F values
   ret<-rep(TRUE,(length(bnd$x)-1))


   # bounding box around the points p1,p2
   p.bbox<-list(x=c(max(p1$x,p2$x),min(p1$x,p2$x)),
                y=c(max(p1$y,p2$y),min(p1$y,p2$y)))

   # iterate over sides (ie vertex pairs)
   # NB the last vertex should be the first
   for (i in 1:(length(bnd$x)-1)){

      # bounding box for the edge
      e.bbox<-list(x=c(max(bnd$x[c(i,i+1)]),min(bnd$x[c(i,i+1)])),
                   y=c(max(bnd$y[c(i,i+1)]),min(bnd$y[c(i,i+1)])))

      # establish whether the bounding boxes intersect
      if(e.bbox$x[1]+eps < p.bbox$x[2]) ret[i]<-FALSE
      if(p.bbox$x[1]+eps < e.bbox$x[2]) ret[i]<-FALSE
      if(e.bbox$y[1]+eps < p.bbox$y[2]) ret[i]<-FALSE
      if(p.bbox$y[1]+eps < e.bbox$y[2]) ret[i]<-FALSE

      # if the bounding boxes do intersect, check that the
      # intersection of the two lines lies within the bounding
      # boxes.
      if(ret[i]){
         # first find the intersection point
         ip<-intersection_point(p1,p2,list(x=bnd$x[c(i,i+1)],y=bnd$y[c(i,i+1)]))

         # first need to handle the horizontal and vertical line cases
         # then handle whether the intersection point lies within the
         # the bounding box
         if(abs(e.bbox$x[1]-e.bbox$x[2])>eps){
            if(ip$x>e.bbox$x[1] | ip$x<e.bbox$x[2]) ret[i]<-FALSE
         }

         if(abs(p.bbox$x[1]-p.bbox$x[2])>eps){
            if(ip$x>p.bbox$x[1] | ip$x<p.bbox$x[2]) ret[i]<-FALSE
         }

         if(abs(e.bbox$y[1]-e.bbox$y[2])>eps){
            if(ip$y>e.bbox$y[1] | ip$y<e.bbox$y[2]) ret[i]<-FALSE
         }

         if(abs(p.bbox$y[1]-p.bbox$y[2])>eps){
            if(ip$y>p.bbox$y[1] | ip$y<p.bbox$y[2]) ret[i]<-FALSE
         }

      }
#DEBUG
#if(ret[i]){
#   lines(x=e.bbox$x,y=rep(e.bbox$y[1],2),col="green",lwd=4)
#   lines(x=e.bbox$x,y=rep(e.bbox$y[2],2),col="green",lwd=4)
#   lines(x=rep(e.bbox$x[1],2),y=rep(e.bbox$y),col="green",lwd=4)
#   lines(x=rep(e.bbox$x[2],2),y=rep(e.bbox$y),col="green",lwd=4)
#   a<-scan()
#}

   }
   return(ret)

}

