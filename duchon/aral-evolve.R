# Aral Sea data set analysis - evolce Duchon...

# libraries
library(mgcv)
library(soap)

library(dillhandy)
library(mdspack)

# load the data and boundary
aral<-read.csv("aral.dat",sep=" ")
bnd<-read.csv("aralbnd.csv")

zlims<-c(1.905461, 19.275249)
zlims<-c(1, 20)

# first cut out the crap using inSide
onoff<-inSide(bnd,aral$lo,aral$la)

# converstion to km
aral.km<-latlong2km(aral$lo[onoff],aral$la[onoff],59.5,45)

aral.dat<-data.frame(x=aral.km$km.e,
                     y=aral.km$km.n,
                     chl=as.numeric(aral$chl[onoff]))

# convert boundary to northings and eastings
bnd.km<-latlong2km(bnd[,2],bnd[,3],59.5,45)
bnd<-list(x=bnd.km$km.e,y=bnd.km$km.n)


# prediction grid
gm<-50;gn<-50
gxm <- seq(min(aral.dat$x),max(aral.dat$x),length=gm)
gyn<-seq(min(aral.dat$y),max(aral.dat$y),length=gn)
gxx <- rep(gxm,gn)
gyy<-rep(gyn,rep(gm,gn))
pred.onoff<-inSide(bnd,gxx,gyy)
pred.grid<-data.frame(x=gxx[pred.onoff],y=gyy[pred.onoff])

######################################################################
# plot setup
par(mfrow=c(2,4),las=1,mgp=c(1.5,0.75,0),mar=c(3,3,2,2),cex.axis=0.5,cex.lab=0.7)

# set the x and y values for the image plot
aral.lab<-latlong2km(unique(sort(aral$lo)),unique(sort(aral$la)),59.5,45)
# set the plot limits
xlims<-c(min(aral.dat$x)-10,max(aral.dat$x)+10)
ylims<-c(min(aral.dat$y)-10,max(aral.dat$y)+10)

######################################################################
#### plot some raw data

aral$chl[!onoff]<-NA
image(z=matrix(aral$chl,46,46),x=aral.lab$km.e,y=aral.lab$km.n,
      asp=1,main="raw data",xlab="km (East)",ylab="km (North)",xlim=xlims,ylim=ylims,zlim=zlims)
lines(bnd,lwd=2)

#######################################################################
##### fit a thin plate model
#tp.fit<-gam(chl~s(x,y,k=70),data=aral.dat,family=Gamma(link="log"))
#
#
#tp.pred<-predict(tp.fit,newdata=pred.grid,type="response")
#pred.mat<-matrix(NA,gm,gn)
#pred.mat[pred.onoff]<-tp.pred
#image(pred.mat,x=unique(gxx),y=unique(gyy),main="tprs",xlab="km (East)",ylab="km (North)",xlim=xlims,ylim=ylims,asp=1)
#contour(z=pred.mat,x=unique(gxx),y=unique(gyy),add=TRUE,labcex=0.5,levels=pretty(zlims,15))
#lines(bnd,lwd=2)
#
#######################################################################
##### soap 
#s.knots<-make_soap_grid(bnd,c(12,12))
#
#soap.fit<-gam(chl~s(x,y,k=49,bs="so",xt=list(bnd=list(bnd))),knots=s.knots,
#            family=Gamma(link="log"),data=aral.dat)
#
## prediction
#soap.pred<-predict(soap.fit,newdata=pred.grid,type="response")
#pred.mat<-matrix(NA,gm,gn)
#pred.mat[pred.onoff]<-soap.pred
#image(pred.mat,x=unique(gxx),y=unique(gyy),xlab="km (East)",ylab="km (North)",main="soap",xlim=xlims,ylim=ylims,asp=1)
#contour(z=pred.mat,x=unique(gxx),y=unique(gyy),add=TRUE,labcex=0.5,levels=pretty(zlims,15))
#lines(bnd,lwd=2)
#
#
#######################################################################
##### MDS

names(aral.dat)<-c("x","y","z")

plot.it<-function(dat,main.title){
   pred.mat<-matrix(NA,gm,gn)
   pred.mat[pred.onoff]<-dat$pred
   image(pred.mat,x=unique(gxx),y=unique(gyy),main=main.title,
         xlab="km (East)",ylab="km (North)",xlim=xlims,ylim=ylims,asp=1,zlim=zlims)
   contour(z=pred.mat,x=unique(gxx),y=unique(gyy),add=TRUE,labcex=0.5,zlim=zlims)#,levels=pretty(zlims,15))
   lines(bnd,lwd=2)
}

#mds2<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20))
load("rly.RData")
plot.it(mds2,"mds 2D - tprs")

# reset the mds dimension, so we can re-use Ds...
mds2$mds.dim<-NULL
mds2$m<-NULL
mds2$bs<-NULL

mds3<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=3,old.obj=mds2,family=Gamma(link="log")) 
plot.it(mds3,"mds 3D - tprs")

mds3.ds<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=3,m=c(2,3/2-1),bs="ds",old.obj=mds2,family=Gamma(link="log"))
plot.it(mds3.ds,"mds 3D - ds, s=0.5")

#mds4.ds<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=4,m=c(2,4/2-1),bs="ds",old.obj=mds2)
#plot.it(mds4.ds,"mds 4D - ds, s=1")
#mds5.ds<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=5,m=c(2,5/2-1),bs="ds",old.obj=mds2)
#plot.it(mds5.ds,"mds 5D - ds, s=1.5")
#mds6.ds<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=6,m=c(2,6/2-1),bs="ds",old.obj=mds2)
#plot.it(mds6.ds,"mds 6D - ds, s=2")
#mds7.ds<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=7,m=c(2,7/2-1),bs="ds",old.obj=mds2)
#plot.it(mds7.ds,"mds 7D - ds, s=2.5")

mds.pick<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=0.8,bs="ds",old.obj=mds2,family=Gamma(link="log"))
plot.it(mds.pick,paste("mds ",mds.pick$mds.dim,"D - ",mds.pick$bs,", s=",mds.pick$m[2]," (0.8 variation)",sep=""))

mds.pick<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=0.85,bs="ds",old.obj=mds2,family=Gamma(link="log"))
plot.it(mds.pick,paste("mds ",mds.pick$mds.dim,"D - ",mds.pick$bs,", s=",mds.pick$m[2]," (0.85 variation)",sep=""))

mds.pick<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=0.9,bs="ds",old.obj=mds2,family=Gamma(link="log"))
plot.it(mds.pick,paste("mds ",mds.pick$mds.dim,"D - ",mds.pick$bs,", s=",mds.pick$m[2]," (0.9 variation)",sep=""))

mds.pick<-gam.mds(aral.dat,pred.grid,bnd,grid.res=c(20,20),mds.dim=0.95,bs="ds",old.obj=mds2,family=Gamma(link="log"))
plot.it(mds.pick,paste("mds ",mds.pick$mds.dim,"D - ",mds.pick$bs,", s=",mds.pick$m[2]," (0.95 variation)",sep=""))

